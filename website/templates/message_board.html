{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header" style="background-color: #FF9F45;">
                    <h2 class="mb-0 text-white">Message Board</h2>
                </div>
                <div class="card-body">
                    <div id="message-container" class="mb-4" style="max-height: 500px; overflow-y: auto;">
                        {% for message in messages %}
                        <div class="message mb-3 {% if message.user_id == current_user.id %}message-right{% else %}message-left{% endif %}">
                            <div class="message-bubble {% if message.user_id == current_user.id %}my-message{% else %}other-message{% endif %}">
                                <div class="message-content">
                                    <div class="message-header">
                                        <strong class="message-author">{{ message.username }}</strong>
                                        <small class="message-time">{{ message.formatted_time }}</small>
                                    </div>
                                    <p class="message-text">{{ message.content }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <form id="message-form" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                            <button type="submit" class="btn" style="background-color: #FF9F45; color: white;">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }
    
    .message-right {
        align-items: flex-end;
    }
    
    .message-left {
        align-items: flex-start;
    }
    
    .message-bubble {
        padding: 0.75rem;
        border-radius: 1.25rem;
        max-width: 80%;
        word-break: break-word;
        position: relative;
    }
    
    .my-message {
        background-color: #FF9F45;
        color: white;
        border-bottom-right-radius: 0.5rem;
        margin-left: auto;
    }
    
    .other-message {
        background-color: #f8f9fa;
        border-bottom-left-radius: 0.5rem;
        margin-right: auto;
    }
    
    .message-info {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    
    .message-author {
        font-weight: 600;
    }
    
    .message-content {
        margin-top: 0.25rem;
    }
    
    #message-container {
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
        padding: 1rem;
    }
    
    #message-container::-webkit-scrollbar {
        width: 6px;
    }
    
    #message-container::-webkit-scrollbar-track {
        background: #f8f9fa;
    }
    
    #message-container::-webkit-scrollbar-thumb {
        background-color: #6c757d;
        border-radius: 3px;
    }
    
    .card-header h2 {
        font-size: 1.5rem;
        margin: 0;
    }

    .input-group .btn {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }

    .input-group .form-control {
        border-radius: 1.5rem 0 0 1.5rem;
    }

    .input-group .btn {
        border-radius: 0 1.5rem 1.5rem 0;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // Get the current URL's protocol and host
    const protocol = window.location.protocol;
    const isSecure = protocol === 'https:';
    
    // Configure Socket.IO connection
    const socket = io({
        transports: ['websocket'],
        secure: isSecure,
        rejectUnauthorized: false,
        path: '/socket.io'
    });

    // Handle form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();
        
        if (content) {
            socket.emit('new_message', { content: content });
            messageInput.value = '';
        }
    });

    // Handle incoming messages
    socket.on('message', function(data) {
        const messageContainer = document.getElementById('message-container');
        const isCurrentUser = data.user_id === {{ current_user.id }};
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message mb-3 ${isCurrentUser ? 'message-right' : 'message-left'}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble ${isCurrentUser ? 'my-message' : 'other-message'}">
                <div class="message-content">
                    <div class="message-header">
                        <strong class="message-author">${data.username}</strong>
                        <small class="message-time">${data.formatted_time}</small>
                    </div>
                    <p class="message-text">${data.content}</p>
                </div>
            </div>
        `;
        
        messageContainer.appendChild(messageDiv);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    });

    // Add error handling for socket connection
    socket.on('connect_error', (error) => {
        console.error('Socket.IO connection error:', error);
    });

    socket.on('connect', () => {
        console.log('Socket.IO connected successfully');
    });
</script>
{% endblock %} 